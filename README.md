# 🤖 بات شورای صنفی دانشجویی

یک بات تلگرام پیشرفته برای ارتباط بین دانشجویان و مسئولین شورای صنفی.

## ✨ ویژگی‌ها

- **ارتباط مستقیم**: پیام‌ها با اطلاعات کامل کاربر ارسال می‌شوند
- **مدیریت ترد**: هر گفتگو در یک ترد جداگانه ذخیره می‌شود
- **انتخاب مسئول**: امکان انتخاب مسئول مورد نظر (دبیر، حقوقی، آموزشی، نشریه)
- **تاریخچه گفتگو**: مشاهده تمام گفتگوهای قبلی
- **پیام‌های جدید**: اطلاع از پیام‌های جدید
- **دکمه بازگشت**: دکمه "🏠 منوی اصلی" در تمام پیام‌ها
- **مدیریت نمونه**: جلوگیری از اجرای همزمان چندین نمونه بات

## 🚀 نصب و راه‌اندازی

### پیش‌نیازها

- Python 3.8 یا بالاتر
- تلگرام بات توکن
- گروه‌های تلگرام برای هر مسئول

### ۱. نصب وابستگی‌ها

```bash
pip install -r requirements.txt
```

### ۲. تنظیم فایل محیطی

فایل `.env` را از `.env.example` کپی کنید:

```bash
cp .env.example .env
```

سپس فایل `.env` را ویرایش کنید:

```env
# Telegram Bot Configuration
TELEGRAM_BOT_TOKEN=your_bot_token_here

# Database Configuration
DATABASE_PATH=./bot_database.db

# Admin Configuration
ADMIN_USER_ID=your_admin_user_id_here

# Role Configuration - Individual User IDs
ROLE_SECRETARY_USER_ID=your_secretary_user_id_here
ROLE_LEGAL_USER_ID=your_legal_user_id_here
ROLE_EDUCATIONAL_1_USER_ID=your_educational_1_user_id_here
ROLE_EDUCATIONAL_2_USER_ID=your_educational_2_user_id_here
ROLE_PUBLICATION_USER_ID=your_publication_user_id_here

```

### ۳. ایجاد بات تلگرام

1. به [@BotFather](https://t.me/BotFather) در تلگرام پیام دهید
2. دستور `/newbot` را ارسال کنید
3. نام و username برای بات انتخاب کنید
4. توکن دریافتی را در فایل `.env` قرار دهید

### ۴. تنظیم مسئولین

برای هر مسئول، شناسه کاربری تلگرام ایشان را در فایل `.env` قرار دهید:

1. **دبیر**
2. **نائب دبیر/مسئول حقوقی**
3. **مسئول آموزش ۱**
4. **مسئول آموزش ۲**
5. **مسئول نشریه**

### ۵. دریافت شناسه کاربری مسئولین

برای دریافت شناسه کاربری هر مسئول:

1. از مسئول بخواهید دستور `/myid` را در بات ارسال کند
2. یا از ایشان بخواهید شناسه کاربری خود را از تنظیمات تلگرام کپی کنند
3. شناسه‌های دریافتی را در فایل `.env` قرار دهید

### ۶. تنظیم کانال لاگ

بات تمام پیام‌ها را در یک کانال تلگرام لاگ می‌کند:

1. یک کانال تلگرام ایجاد کنید
2. بات را به عنوان ادمین به کانال اضافه کنید
3. شناسه کانال را در فایل `.env` قرار دهید:
   ```env
   CHANNEL_ID=-x
   ```
   
**نکته**: شناسه کانال باید منفی باشد (مثل `-x`)

### ۷. اجرای بات

#### روش ساده
```bash
# اجرای بات پیشرفته
python enhanced_bot.py
```

#### استفاده از اسکریپت‌های مدیریتی (توصیه شده)

بات دارای سیستم مدیریت پیشرفته است که از اجرای همزمان چندین نمونه جلوگیری می‌کند:

```bash
# بررسی وضعیت بات
./scripts/check_bot_status.sh

# شروع بات
./scripts/start_bot.sh

# توقف بات
./scripts/stop_bot.sh

# راه‌اندازی مجدد بات
./scripts/restart_bot.sh
```

**مزایای استفاده از اسکریپت‌ها:**
- ✅ جلوگیری از اجرای همزمان چندین نمونه
- ✅ مدیریت خودکار فایل قفل
- ✅ لاگ‌گیری خودکار
- ✅ تشخیص و پاکسازی فایل‌های قفل یتیم
- ✅ نمایش وضعیت دقیق بات

## 📱 نحوه استفاده

### برای دانشجویان

1. **شروع**: دستور `/start` را ارسال کنید
2. **انتخاب مسئول**: از منوی نمایش داده شده مسئول مورد نظر را انتخاب کنید
3. **ارسال پیام**: پیام خود را ارسال کنید (اطلاعات شما برای مسئول ارسال می‌شود)
4. **مشاهده پاسخ**: پاسخ مسئول به شما ارسال خواهد شد
5. **بازگشت**: از دکمه "🏠 منوی اصلی" برای بازگشت استفاده کنید

### دستورات مفید

- `/start` - شروع مجدد بات
- `/new` - شروع گفتگوی جدید
- `/history` - مشاهده تاریخچه گفتگو
- `/back` - بازگشت به منوی اصلی
- `/cancel` - لغو گفتگو

### دکمه‌های مفید

- **🏠 منوی اصلی** - بازگشت به انتخاب مسئول (در تمام پیام‌ها موجود است)
- **📋 گفتگوهای قبلی** - مشاهده گفتگوهای گذشته
- **🆕 گفتگوی جدید** - شروع گفتگوی جدید
- **📊 آمار پیام‌ها** - تعداد پیام‌های جدید
- **❌ لغو گفتگو** - لغو گفتگو و بازگشت به منوی اصلی

**نکته**: دکمه **🏠 منوی اصلی** در تمام پیام‌های ارسالی به کاربران موجود است و امکان بازگشت سریع به منوی اصلی را فراهم می‌کند.

### برای مسئولین

1. **تنظیم شناسه**: شناسه کاربری خود را در فایل `.env` قرار دهید
2. **دریافت پیام**: پیام‌های دانشجویان با اطلاعات کامل (نام، شناسه، نام کاربری) برای شما ارسال می‌شود
3. **پاسخ**: روی پیام دانشجو ریپلای کنید تا پاسخ ارسال شود
4. **دستورات مدیریتی**: از دستورات `/reply`، `/threads`، `/block` استفاده کنید

## 🗄️ ساختار دیتابیس

بات از SQLite برای ذخیره اطلاعات استفاده می‌کند:

### جداول اصلی

- **users**: اطلاعات کاربران
- **roles**: نقش‌های مسئولین
- **threads**: تردهای گفتگو
- **messages**: پیام‌های ارسالی

## 🔧 تنظیمات پیشرفته

### اضافه کردن نقش جدید

برای اضافه کردن نقش جدید، فایل `database.py` را ویرایش کنید:

```python
# در تابع init_database، به لیست default_roles اضافه کنید:
('نام نقش جدید', 'ROLE_NEW_GROUP_ID', 'توضیحات نقش')
```

### تغییر محدودیت‌ها

در فایل `config.py` می‌توانید محدودیت‌ها را تغییر دهید:

```python
MAX_MESSAGE_LENGTH = 4096  # حداکثر طول پیام
MAX_MESSAGES_PER_DAY = 5   # حداکثر پیام در روز
```

## 🛡️ امنیت

- پیام‌ها با اطلاعات کامل کاربر (نام، شناسه، نام کاربری) ارسال می‌شوند
- مسئولین می‌توانند اطلاعات دانشجو را مشاهده کنند
- ارتباط فقط از طریق بات انجام می‌شود
- امکان محدودیت تعداد پیام‌ها وجود دارد
- سیستم مدیریت نمونه از اجرای همزمان چندین بات جلوگیری می‌کند

## 🐛 عیب‌یابی

### مشکلات رایج

1. **خطای توکن**: توکن بات را بررسی کنید
2. **خطای گروه**: شناسه گروه‌ها را بررسی کنید
3. **خطای دیتابیس**: فایل دیتابیس را حذف کنید تا مجدداً ایجاد شود
4. **خطای "Another instance is running"**: 
   - از اسکریپت `./scripts/stop_bot.sh` استفاده کنید
   - یا فایل `bot.lock` را حذف کنید: `rm bot.lock`
5. **فایل قفل یتیم**: اسکریپت‌ها به طور خودکار فایل‌های قفل یتیم را پاکسازی می‌کنند

## 📁 ساختار پروژه

```
bot/
├── enhanced_bot.py      # فایل اصلی بات
├── config.py           # تنظیمات بات
├── database.py         # مدیریت دیتابیس
├── requirements.txt    # وابستگی‌های پایتون
├── .env               # متغیرهای محیطی
├── .env.example       # نمونه فایل محیطی
├── bot_database.db    # فایل دیتابیس
├── README.md          # راهنمای پروژه
├── QUICK_DEPLOY.md    # راهنمای سریع نصب
└── scripts/           # اسکریپت‌های کمکی
    ├── check_bot_status.sh  # بررسی وضعیت بات
    ├── start_bot.sh         # شروع بات
    ├── stop_bot.sh          # توقف بات
    ├── restart_bot.sh       # راه‌اندازی مجدد بات
    ├── deploy_local.sh
    ├── deploy_vps.sh
    ├── run_bot.sh
    ├── setup_local.sh
    ├── status_local.sh
    ├── test_local.sh
    ├── update_env.sh
    └── admin_panel_local.sh
```




**نکته**: این بات برای استفاده در محیط‌های آموزشی طراحی شده است. لطفاً از آن به صورت مسئولانه استفاده کنید. # senfiBot
